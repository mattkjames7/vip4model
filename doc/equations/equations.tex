\documentclass[]{article}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{natbib}

\usepackage[a4paper, margin=1in]{geometry}

%opening
\title{Magnetic Field Model Equations and a Load of Legendre Polynomials}
\author{Matt James}

\begin{document}

\maketitle


\section{Legendre Polynomials}

	This is the form of a Legendre polynomial (Rodrigues' formula):
	
	\begin{equation}
		P_n(x) = \frac{1}{2^n n!}\frac{\text{d}^n}{\text{d}x^n}(x^2 - 1)^n \label{EqLegendre}
	\end{equation}
	where $n$ is the degree of the polynomial. The first 5 degrees (0-4) are shown below:
	
	\begin{align}
		P_0(x) &= \frac{\text{d}^0}{\text{d}x^0} (x^2 - 1)^0 &= 1, \label{EqP0} \\
		P_1(x) &= \frac{1}{2} \frac{\text{d}}{\text{d}x} (x^2 - 1) &= x, \label{EqP1} \\
		P_2(x) &= \frac{1}{8} \frac{\text{d}^2}{\text{d}x^2} (x^2 - 1)^2 &= \frac{1}{2}(3x^2 - 1), \label{EqP2} \\
		P_3(x) &= \frac{1}{48} \frac{\text{d}^3}{\text{d}x^3} (x^2 - 1)^3 &= \frac{1}{2}(5x^3 - 3x), \label{EqP3} \\
		P_4(x) &= \frac{1}{384} \frac{\text{d}^4}{\text{d}x^4} (x^2 - 1)^4 &= \frac{1}{8}(35x^4 - 30x^2 + 3), \label{EqP4}
	\end{align}
 	and $x$ can be substituted for $\cos{\theta}$:
	
	\begin{align}
		P_0(\cos{\theta}) &= 1 \label{EqP0t}, \\
		P_1(\cos{\theta}) &= \cos{\theta}, \label{EqP1t} \\
		P_2(\cos{\theta}) &= \frac{1}{2}(3\cos^2{\theta} - 1 \label{EqP2t}), \\
		P_3(\cos{\theta}) &= \frac{1}{2}(5\cos^3{\theta} - 3\cos{\theta}), \label{EqP3t} \\
		P_4(\cos{\theta}) &= \frac{1}{8}(35\cos^4{\theta} - 30x^2 + 3). \label{EqP4t}		
	\end{align}
	
	\subsection{Derivatives}
		
		These derivatives of the above equations \ref{EqP0}--\ref{EqP4} with respect to $x$ will come in handy later on...
		
		For equation \ref{EqP0}:
		
		\begin{align}
			\frac{\text{d}}{\text{d} x}P_0 (x) &= 0. \label{Eqd1P0}
		\end{align}

		For equation \ref{EqP1}:

		\begin{align}
			\frac{\text{d}}{\text{d} x} P_1 (x) &= 1. \label{Eqd1P1}
		\end{align}
		
		For equation \ref{EqP2}:

		\begin{align}
			\frac{\text{d}}{\text{d} x} P_2 (x) &= 3x, \label{Eqd1P2} \\
			\frac{\text{d}^2}{\text{d} x^2} P_2 (x) &= 3. \label{Eqd2P2}
		\end{align}
		
		For equation \ref{EqP3}:
		
		\begin{align}
			\frac{\text{d}}{\text{d} x} P_3 (x) &= \frac{1}{2}(15x^2 - 3), \label{Eqd1P3} \\
			\frac{\text{d}^2}{\text{d} x^2} P_3 (x) &= 15x, \label{Eqd2P3} \\
			\frac{\text{d}^3}{\text{d} x^3} P_3 (x) &= 15. \label{Eqd3P3}
		\end{align}
		
		For equation \ref{EqP4}:

		\begin{align}
			\frac{\text{d}}{\text{d} x} P_4 (x) &= \frac{5}{2}(7x^3 - 3x), \label{Eqd1P4} \\
			\frac{\text{d}^2}{\text{d} x^2} P_4 (x) &= \frac{15}{2}(7x^2 - 1), \label{Eqd2P4} \\
			\frac{\text{d}^3}{\text{d} x^3} P_4 (x) &= 105x, \label{Eqd3P4} \\
			\frac{\text{d}^4}{\text{d} x^4} P_4 (x) &= 105. \label{Eqd4P4}
		\end{align}
			
\section{Ferrers Normalized Legendre Polynomials}

	The associated Legendre polynomials are defined by \cite{Ferrers1877} as:
	
	\begin{equation}
		P_{n,m}(x) = (1 - x^2)^\frac{m}{2} \frac{\text{d}^m}{\text{d}x^m} P_n(x) \label{EqFerrers},
	\end{equation}
	where $m$ is the order.


	Some equations and their derivatives...
	
	\begin{align}
		P_{0,0} (x) &= 1, \\
		P_{0,0} (\cos{\theta}) &= 1, \\
		\frac{\text{d}}{\text{d} \theta} P_{0,0} &= 0.
	\end{align}

	\begin{align}
		P_{1,0} (x) &= x, \\
		P_{1,0} (\cos{\theta}) &= \cos{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{1,0} &= -\sin{\theta}.
	\end{align}
	
	\begin{align}
		P_{1,1} (x) &= (1 - x^2)^\frac{1}{2}, \\
		P_{1,1} (\cos{\theta}) &= \sin{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{1,1} &= \cos{\theta}.
	\end{align}

	
	\begin{align}
		P_{2,0} (x) &= \frac{1}{2} (3 x^2 - 1), \\
		P_{2,0} (\cos{\theta}) &= \frac{1}{2}(3\cos^2{\theta} - 1), \\
		\frac{\text{d}}{\text{d} \theta} P_{2,0} &= -3\cos{\theta}\sin{\theta}.
	\end{align}

	\begin{align}
		P_{2,1} (x) &= 3x(1-x^2)^\frac{1}{2}, \\
		P_{2,1} (\cos{\theta}) &= 3\cos{\theta}\sin{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{2,1} &= 3(2\cos^2{\theta}-1).
	\end{align}

	\begin{align}
		P_{2,2} (x) &= 3(1-x^2), \\
		P_{2,2} (\cos{\theta}) &= 3\sin^2{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{2,2} &= 6\sin{\theta}\cos{\theta}.
	\end{align}

	\begin{align}
		P_{3,0} (x) &= \frac{1}{2} (5x^3 - 3x), \\
		P_{3,0} (\cos{\theta}) &= \frac{1}{2} (5 \cos^3{\theta} - 3\cos{\theta}), \\
		\frac{\text{d}}{\text{d} \theta} P_{3,0} &= \frac{3}{2} \sin{\theta} (1 - 5 \cos^2{\theta}).
	\end{align}


	\begin{align}
		P_{3,1} (x) &= \frac{1}{2} \sqrt{(1-x^2)}(15x^2 - 3), \\
		P_{3,1} (\cos{\theta}) &= \frac{3}{2} \sin{\theta}(5\cos^2{\theta} -1), \\
		\frac{\text{d}}{\text{d} \theta} P_{3,1} &= \frac{3}{2} \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}(5\cos^2{\theta}-1) + (5\cos^2{\theta} - 1)\frac{\text{d}}{\text{d}\theta}\sin{\theta}\right], \\
		&= \frac{3}{2} (15\cos^3{\theta} - 11\cos{\theta}).
	\end{align}

	\begin{align}
		P_{3,2} (x) &= 15x (1-x^2), \\
		P_{3,2} (\cos{\theta}) &= 15 \cos{\theta} \sin^2{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{3,2} &= 15 \sin{\theta} (3\cos^2{\theta} - 1).
	\end{align}

	\begin{align}
		P_{3,3} (x) &= 15(1-x^2)^\frac{3}{2}, \\
		P_{3,3} (\cos{\theta}) &= 15 \sin^3{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{3,3} &= 45 \sin^2{\theta}\cos{\theta}.
	\end{align}

	\begin{align}
		P_{4,0} (x) &= \frac{1}{8}(35x^4 - 30x^2 + 3), \\
		P_{4,0} (\cos{\theta}) &= \frac{1}{8}(35 \cos^4{\theta} - 30\cos^2{\theta} + 3), \\
		\frac{\text{d}}{\text{d} \theta} P_{4,0} &= \frac{5}{2}(7\cos^3{\theta} - 3\cos{\theta}).
	\end{align}


	\begin{align}
		P_{4,1} (x) &= \frac{5}{2}(7x^3 - 3x) (1-x^2)^\frac{1}{2}, \\
		P_{4,1} (\cos{\theta}) &= \frac{5}{2} \sin{\theta}(7\cos^3{\theta} - 3\cos{\theta}), \\
		\frac{\text{d}}{\text{d} \theta} P_{4,1} &= \frac{5}{2}\left[(7\cos^3{\theta} - 3\cos{\theta})\frac{\text{d}}{\text{d}\theta}\sin{\theta} + \sin{\theta} \frac{\text{d}}{\text{d}\theta}(7\cos^3{\theta} - 3\cos{\theta})\right], \\
		&= \frac{5}{2}(28 \cos^4{\theta} - 27 \cos^3{\theta} + 3).
	\end{align}
	


	\begin{align}
		P_{4,2} (x) &= \frac{15}{2}(7x^2 - 1) (1-x^2), \\
		P_{4,2} (\cos{\theta}) &= \frac{15}{2} \sin^2{\theta}(7\cos^2{\theta} - 1), \\
		\frac{\text{d}}{\text{d} \theta} P_{4,2} &= \frac{15}{2}\left[(7\cos^2{\theta} - 1)\frac{\text{d}}{\text{d}\theta}\sin^2{\theta} + \sin^2{\theta} \frac{\text{d}}{\text{d}\theta}(7\cos^2{\theta} - 1)\right], \\
		&= 30\cos{\theta}\sin{\theta}(7\cos^2{\theta} - 4).
	\end{align}

	\begin{align}
		P_{4,3} (x) &= 105x(1-x^2)^\frac{3}{2}, \\
		P_{4,3} (\cos{\theta}) &= 105 \cos{\theta}\sin^3{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{4,3} &= 105\left[\cos{\theta}\frac{\text{d}}{\text{d}\theta}\sin^3{\theta} + \sin^3{\theta}\frac{\text{d}}{\text{d}\theta}\cos{\theta}\right], \\
		&= 105 \sin^2{\theta}(4\cos^2{\theta} - 1).
	\end{align}	

	\begin{align}
		P_{4,4} (x) &= 105(1-x^2)^2, \\
		P_{4,4} (\cos{\theta}) &= 105 \sin^4{\theta}, \\
		\frac{\text{d}}{\text{d} \theta} P_{4,4} &= 420 \sin^3{\theta} \cos{\theta}.
	\end{align}	
	
	\subsection{Recurrence Relations}
		\label{SectRecurrence}
		There are three recurrence relations which are used to calculate the associate polynomials from lower order/degree polynomials. 
		
		\begin{align}
			&\text{A: }  m < n-1  \nonumber \\ 
			&P_{n,m} (\cos{\theta}) = \frac{1}{n-m} \left[(2n-1)\cos{\theta} P_{n-1,m} - (n + m -1)P_{n-2,m}\right] \\
			&\text{B: }  m = n-1  \nonumber \\ 
			&P_{n,m} (\cos{\theta}) = (2n-1)\sin{\theta} P_{n-1,m-1}, \\
			&\text{C: }  m = n  \nonumber \\ 
			&P_{n,m} (\cos{\theta}) = (2n-1)\sin{\theta} P_{n-1,m-1}.
		\end{align}
		
		They are based on code used elsewhere, but the difference being that a factor of $(-1)^m$ was removed from rule C (and also from their calculation of $S_{n,m}$ as the seem to cancel each other). Also rule B uses $\sin$ here as opposed to $\cos$ (I think the original code had a mistake in it). These changes effectively make rules B and C identical. The examples below should all match with those derived directly from equations \ref{EqLegendre} and \ref{EqFerrers} in the previous subsection.
		
		Examples for case A:
		
		\begin{align}
			P_{2,0} &= \frac{1}{2}\left[ 3\cos{\theta} P_{1,0} - P_{0,0} \right] \\
					&= \frac{1}{2}(3\cos^2{\theta} - 1) \\
			P_{3,0} &= \frac{1}{3}\left[5\cos{\theta}P_{2,0} - 2P_{1,0}\right] \\
					&= \frac{1}{2}(5 \cos^3{\theta} - 3\cos{\theta}) \\
			P_{3,1} &= \frac{1}{2}\left[5 \cos{\theta} P_{2,1} - 3P_{1,1}\right] \\
					&= \frac{3}{2}\sin{\theta}\left[5 \cos^2{\theta} - 1\right] \\
			P_{4,0} &= \frac{1}{4}\left[7\cos{\theta}P_{3,0} - 3P_{2,0}\right] \\
					&= \frac{1}{8}(35 \cos^4{\theta} - 30\cos^2{\theta} + 3) \\
			P_{4,1} &= \frac{1}{3}\left[7\cos{\theta} P_{3,1} - 4P_{2,1}\right] \\
					&= \frac{5}{2}\sin{\theta}\cos{\theta}(7\cos^2{\theta} - 3) \\
			P_{4,2} &= \frac{1}{2}\left[7\cos{\theta}P_{3,2} - 5P_{2,2}\right] \\
					&= \frac{15}{2}\sin^2{\theta}(7\cos^2{\theta} -1)
		\end{align}
		
		Examples for case B:
		
		\begin{align}
			P_{2,1} &= 3\sin{\theta}P_{1,0} \\
					&= 3\sin{\theta}\cos{\theta} \\
			P_{3,2} &= 5\sin{\theta}P_{2,1} \\
					&= 15\sin^2{\theta}\cos{\theta} \\
			P_{4,3} &= 7\sin{\theta}P_{3,2} \\
					&= 105\sin^3{\theta}\cos{\theta} 
		\end{align}
		
		Examples for case C (I think this rule is basically the same as B):
		
		\begin{align}
			P_{1,1} &= \sin{\theta}P_{0,0} \\
					&= \sin{\theta} \\
			P_{2,2} &= 3\sin{\theta}P_{1,1} \\
					&= 3\sin^2{\theta} \\
			P_{3,3} &= 5\sin{\theta}P_{2,2} \\
					&= 15\sin^3{\theta} \\
			P_{4,4} &= 7\sin{\theta}P_{3,3} \\
					&= 105\sin^4{\theta}
		\end{align}
		
		The derivatives can be calculated using similar rules:
		
		\begin{align}
			&\text{A: }  m < n-1  \nonumber \\ 
			&\frac{\text{d}}{\text{d}\theta} P_{n,m} = \frac{1}{n-m} \left[(2n-1)\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{n-1,m} - \sin{\theta}P_{n-1,m}\right) - (n+m-1)\frac{\text{d}}{\text{d}\theta}P_{n-2,m}\right] \\
			&\text{B: }  m = n-1  \nonumber \\ 
			&\frac{\text{d}}{\text{d}\theta} P_{n,m} = (2n-1) \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{n-1,m-1} + \cos{\theta}P_{n-1,m-1}\right] \\
			&\text{C: }  m = n  \nonumber \\ 
			&\frac{\text{d}}{\text{d}\theta} P_{n,m} = (2n-1) \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{n-1,m-1} + \cos{\theta}P_{n-1,m-1}\right]
		\end{align}
		
		Examples for case A:
		
		\begin{align}
			\frac{\text{d}}{\text{d}\theta}P_{2,0} &= \frac{1}{2}\left[3\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{1,0} - \sin{\theta}P_{1,0}\right) - \frac{\text{d}}{\text{d} \theta} P_{0,0}\right] \\
				&= \frac{1}{2} (3 \cos^2{\theta} -1)\\
			\frac{\text{d}}{\text{d}\theta}P_{3,0} &= \frac{1}{3}\left[5\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{2,0} - \sin{\theta}P_{2,0}\right) - 2\frac{\text{d}}{\text{d} \theta} P_{1,0}\right] \\
				&= \frac{1}{2}(5\cos^3{\theta} - 3\cos{\theta})\\
			\frac{\text{d}}{\text{d}\theta}P_{3,1} &= \frac{1}{2}\left[5\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{2,1} - \sin{\theta}P_{2,1}\right) - 3\frac{\text{d}}{\text{d} \theta} P_{1,1}\right] \\
				&= \frac{3}{2}\sin{\theta}(5\cos^2{\theta} - 1)\\
			\frac{\text{d}}{\text{d}\theta}P_{4,0} &= \frac{1}{4}\left[7\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{3,0} - \sin{\theta}P_{3,0}\right) - 3\frac{\text{d}}{\text{d} \theta} P_{2,0}\right] \\
				&= \frac{1}{8}(35\cos^4{\theta} - 30\cos^2{\theta} + 3)\\
			\frac{\text{d}}{\text{d}\theta}P_{4,1} &= \frac{1}{3}\left[7\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{3,1} - \sin{\theta}P_{3,1}\right) - 4\frac{\text{d}}{\text{d} \theta} P_{2,1}\right] \\
				&= \frac{5}{2} \sin{\theta}\cos{\theta}(7\cos^2{\theta} - 3) \\
			\frac{\text{d}}{\text{d}\theta}P_{4,2} &= \frac{1}{2}\left[7\left(\cos{\theta}\frac{\text{d}}{\text{d}\theta}P_{3,2} - \sin{\theta}P_{3,2}\right) - 5\frac{\text{d}}{\text{d} \theta} P_{2,2}\right] \\
				&= \frac{15}{2}\sin^2{\theta}(7\cos^2{\theta} - 1)
		\end{align}
		
		Examples for case B:
		
		\begin{align}
			\frac{\text{d}}{\text{d}\theta}P_{2,1} &= 3 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{1,0} + \cos{\theta}P_{1,0}\right] \\
			&= 6 \cos^2{\theta} - 3\\
			\frac{\text{d}}{\text{d}\theta}P_{3,2} &= 5 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{2,1} + \cos{\theta}P_{2,1}\right] \\
			&= 15\sin{\theta}(3\cos^2{\theta} -1)\\
			\frac{\text{d}}{\text{d}\theta}P_{4,3} &= 7 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{3,2} + \cos{\theta}P_{3,2}\right] \\
			&= 105\sin^2{\theta}(4\cos^2{\theta} - 1)
		\end{align}

		Examples for case C:
		
		\begin{align}
			\frac{\text{d}}{\text{d}\theta}P_{2,2} &= 3 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{1,1} + \cos{\theta}P_{1,1}\right] \\
			&= 6 \cos{\theta}\sin{\theta} \\
			\frac{\text{d}}{\text{d}\theta}P_{3,3} &= 5 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{2,2} + \cos{\theta}P_{2,2}\right] \\
			&= 45\cos{\theta}\sin^2{\theta}\\
			\frac{\text{d}}{\text{d}\theta}P_{4,4} &= 7 \left[\sin{\theta}\frac{\text{d}}{\text{d}\theta}P_{3,3} + \cos{\theta}P_{3,3}\right] \\
			&= 420\cos{\theta}\sin^3{\theta}
		\end{align}
		
	
		The recurrence relations listed above can be used to calculate any of the associated Legendre polynomials provided that $P_{0,0}$, $P_{1,0}$ and $P_{1,1}$ are defined initially. Here are some examples below, where the left polynomial is formed using the polynomial(s) to the right of the arrow and the letter in brackets corresponds to the three rules listed above:
		
		\begin{align}
			P_{2,0} &\leftarrow P_{1,0},P_{0,0} &(C) \\
			P_{2,1} &\leftarrow P_{1,0}			&(B) \\
			P_{2,2} &\leftarrow P_{1,1}			&(A) \\
			\nonumber \\
			P_{3,0} &\leftarrow P_{2,0},P_{1,0} &(C) \\
			P_{3,1} &\leftarrow P_{2,1},P_{1,1} &(C) \\
			P_{3,2} &\leftarrow P_{2,1}			&(B) \\
			P_{3,3} &\leftarrow P_{2,2}			&(A) \\
			\nonumber \\
			P_{4,0} &\leftarrow P_{3,0},P_{2,0} &(C) \\
			P_{4,1} &\leftarrow P_{3,1},P_{2,1} &(C) \\
			P_{4,2} &\leftarrow P_{3,2},P_{2,2} &(C) \\
			P_{4,3} &\leftarrow P_{3,2}			&(B) \\
			P_{4,4} &\leftarrow P_{3,3}			&(A) 
		\end{align}
	
		Note that the same rules apply for the derivatives too.
		
\section{Schmidt Normalized Legendre Polynomials}
	
	The Schmidt normalized Legendre polynomials, $P_n^m$, are defined by
	
	\begin{equation}
		P_n^m = S_n^m P_{n,m},
	\end{equation}
	
	where 
	
	\begin{equation}
		S_{n,m} = \sqrt{(2-\delta_m^0)\frac{(n-m)!}{(n+m)!}},
	\end{equation}
	
	and $\delta_m^0 = 1$ when $m = 0$, and is $\delta_m^0 = 0$ otherwise.
	
\section{Calculating the Magnetic Field Model}

	The magnetic field, $\mathbf{B}$, is calculated from a scalar potential,
	
	\begin{equation}
		\mathbf{B} = -\mathbf{\nabla} V, \label{EqScPot}
	\end{equation}
	
	where $\mathbf{\nabla} = \left(\frac{\partial}{\partial r},\frac{1}{r}\frac{\partial}{\partial \theta},\frac{1}{r \sin{\theta}} \frac{\partial}{\partial \phi} \right) $ in spherical polar coordinates, $V$ is defined as \cite[e.g.][]{Connerney1998,Winch2005},
	
	\begin{equation}
		V = a\sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{n+1} \sum_{m=0}^{n} \left\{P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right]\right\}, \label{EqSphHarm}
	\end{equation}
	
	and $a$ is the radius of Jupiter (71,398~km).
	
	Using equation \ref{EqScPot} on \ref{EqSphHarm}, each component of the magnetic field is defined by,
	
	\begin{align}
		B_r &= -\frac{\partial V}{\partial r} &= \sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{n+2} (n+1) \sum_{m=0}^{n} \left\{P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right]\right\}, \\
		B_\theta &= -\frac{1}{r}\frac{\partial V}{\partial \theta} &= -\sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{n+2} \sum_{m=0}^{n} \left\{\frac{\text{d}}{\text{d}\theta} P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right]\right\}, \\
		B_\phi &= -\frac{1}{r\sin{\theta}}\frac{\partial V}{\partial \phi} &= -\frac{1}{\sin{\theta}}\sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{n+2} \sum_{m=0}^{n} \left\{mP_n^m(\cos{\theta}) \left[h_n^m \cos{(m\phi)} - g_n^m\sin{(m\phi)}\right]\right\}.
	\end{align}
	
	In the code, the above equations use $a =1$ and $r$ in units of $R_J$.
	
	\subsection{Cartesian Solution}
		
		Possibly dodgy derivation of the Cartesian solution to equation \ref{EqScPot}, i.e.
		
		\begin{equation}
			\mathbf{B} = -\left(\frac{\partial}{\partial x},\frac{\partial}{\partial y},\frac{\partial}{\partial z}\right) V. \label{EqSphHarmCart}
		\end{equation}
	
		This will be done by splitting equation \ref{EqSphHarm} into several parts and combining them at the end...
		
		\subsubsection{Part 1}
			
			The derivatives of 
			\begin{equation} 
				a \left(\frac{a}{r}\right)^{n+1},
			\end{equation}
			where $r = \sqrt{x^2 + y^2 + z^2}$ and we will define $u = a/r$.
			\begin{align}
				\frac{\partial}{\partial x} \left[ a \left( \frac{a}{r}\right)^{n+1} \right] &= a \frac{\text{d} u}{\text{d} u} u^{n+1} \cdot \frac{\text{d} u}{\text{d} r} \cdot \frac{\text{d} r}{\text{d} x},\\
				&= a\left((n+1)u^n\right)\cdot \left(-\frac{u^2}{a}\right) \cdot \left( \frac{a}{r}\right), \\
				&= -(n+1)\left(\frac{x}{r}\right)\left(\frac{a}{r}\right)^{n+2}.
			\end{align}
			
			All three components have similar solutions:
			
			\begin{align}
				\frac{\partial}{\partial x} \left[ a \left( \frac{a}{r}\right)^{n+1} \right] &= -(n+1)\left(\frac{x}{r}\right)\left(\frac{a}{r}\right)^{n+2}, \\
				\frac{\partial}{\partial y} \left[ a \left( \frac{a}{r}\right)^{n+1} \right] &= -(n+1)\left(\frac{y}{r}\right)\left(\frac{a}{r}\right)^{n+2}, \\
				\frac{\partial}{\partial z} \left[ a \left( \frac{a}{r}\right)^{n+1} \right] &= -(n+1)\left(\frac{z}{r}\right)\left(\frac{a}{r}\right)^{n+2}.
			\end{align}
		
		\subsubsection{Part 2}
			
			The derivatives of $P_n^m(\cos\theta)$ for each component can be done using the chain rule, e.g.:
			
			\begin{equation}
				\frac{\partial}{\partial x} P_n^m(\cos\theta) = \frac{\text{d}}{\text{d} \theta} P_n^m(\cos\theta) \frac{\partial \theta}{\partial x}.
			\end{equation}
			
			Using
			\begin{equation}
			\theta = \arccos\frac{z}{r} = \arccos{\frac{z}{\sqrt{x^2 + y^2 + z^2}}},
			\end{equation}
			and 
			\begin{equation}
				\frac{\text{d}}{\text{d} u} \arccos{u} = \frac{-1}{\sqrt{1 - u^2}}, 
			\end{equation}
			the derivatives of $\theta$ are:
			\begin{align}
				\frac{\partial \theta}{\partial x} &= \frac{xz}{\rho r^2}, \\
				\frac{\partial \theta}{\partial y} &= \frac{yz}{\rho r^2}, \\
				\frac{\partial \theta}{\partial z} &= \frac{\rho^2}{r^3}, 
			\end{align}
			where $\rho = \sqrt{x^2 + y^2}$.
			
			Legendre polynomials are therefore,
			\begin{align}
				\frac{\partial}{\partial x} P_n^m(\cos\theta) &= \left(\frac{xz}{\rho r^2}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos\theta), \\
				\frac{\partial}{\partial y} P_n^m(\cos\theta) &= \left(\frac{yz}{\rho r^2}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos\theta), \\
				\frac{\partial}{\partial z} P_n^m(\cos\theta) &= \left(\frac{\rho^2}{r^3}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos\theta), 
			\end{align}	
			where $\frac{\text{d}}{\text{d} \theta} P_n^m(\cos\theta)$ is already calculated using the spherical polar version of the code (see section \ref{SectRecurrence}).
		
		\subsubsection{Part 3}		
		
			This section deals with the derivative of 
			\begin{equation}
				g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)},
			\end{equation}	
			which will be treated as a chain rule, e.g.
			\begin{equation}
				\frac{\partial}{\partial x}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right) = \frac{\text{d}}{\text{d}\phi}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right)\cdot\frac{\partial\phi}{\partial x}.
			\end{equation}
			
			The first step in that chain rule is as follows (and used in the spherical polar version),
			\begin{equation}
				\frac{\text{d}}{\text{d}\phi}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right) = m\left( h_n^m \cos{(m\phi)} - g_n^m \sin{(m\phi)}\right). \label{Eqdghdphi}
			\end{equation}
			
			Using $\phi = \arctan{(y/x)}$ and the fact that
			\begin{equation}
				\frac{\text{d}}{\text{d} u} \arctan{u} = \frac{1}{1 + u^2},
			\end{equation}
			the three derivatives of $\phi$ are,
			\begin{align}
				\frac{\partial \phi}{\partial x} = \frac{1}{1 + \left(\frac{y}{x}\right)^2}\cdot\frac{-y}{x^2} &= \frac{-y}{\rho}, \label{Eqdphidx} \\
				\frac{\partial \phi}{\partial y} = \frac{1}{1 + \left(\frac{y}{x}\right)^2}\cdot\frac{1}{x} &= \frac{x}{\rho},\label{Eqdphidy} \\ 
				\frac{\partial \phi}{\partial z} = \frac{1}{1 + \left(\frac{y}{x}\right)^2}\cdot 0 &= 0. \label{Eqdphidz}
			\end{align}
			
			Combining equation \ref{Eqdghdphi} with equations \ref{Eqdphidx}-\ref{Eqdphidz} gives,
			\begin{align}
				\frac{\partial}{\partial x}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right) &= -m\frac{y}{\rho}\left( h_n^m \cos{(m\phi)} - g_n^m \sin{(m\phi)}\right), \\
				\frac{\partial}{\partial y}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right) &= m\frac{x}{\rho}\left( h_n^m \cos{(m\phi)} - g_n^m \sin{(m\phi)}\right), \\
				\frac{\partial}{\partial z}\left(g_n^m \cos{(m\phi)} + h_n^m\sin{(m\phi)}\right) &= 0
			\end{align}
		
		\subsubsection{Combined solution}	
			
			Using the three parts above to solve equation \ref{EqSphHarmCart}:
			
			\begin{align}
				B_x = -\frac{\partial V}{\partial x} &= \sum_{n=1}^{n_{max}} (n + 1)\left(\frac{x}{r}\right)\left(\frac{a}{r}\right)^{(n+2)} \sum_{m=0}^{n} \left\{ P_n^m(\cos{\theta}) \left[ g_n^m \cos{(m\phi)} + h_n^m \sin{(m\phi)}\right] \right\}    \nonumber \\
				&- a \sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{(n+1)} \sum_{m=0}^{n} \biggl\{ \left(\frac{xz}{\rho r^2}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi} + h_n^m \sin{(m\phi)} \right] \nonumber \\
				&+ m\frac{y}{\rho} P_n^m(\cos{\theta}) \left[ g_n^m\sin{(m\phi)} - h_n^m \cos{(m\phi)}\right]  \biggr\} \\
				B_y = -\frac{\partial V}{\partial y} &= \sum_{n=1}^{n_{max}} (n + 1)\left(\frac{y}{r}\right)\left(\frac{a}{r}\right)^{(n+2)} \sum_{m=0}^{n} \left\{ P_n^m(\cos{\theta}) \left[ g_n^m \cos{(m\phi)} + h_n^m \sin{(m\phi)}\right] \right\}    \nonumber \\
				&- a \sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{(n+1)} \sum_{m=0}^{n} \biggl\{ \left(\frac{yz}{\rho r^2}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi} + h_n^m \sin{(m\phi)} \right] \nonumber \\
				&+ m\frac{x}{\rho} P_n^m(\cos{\theta}) \left[ h_n^m \cos{(m\phi)} - g_n^m\sin{(m\phi)}\right]  \biggr\} \\
				B_z = -\frac{\partial V}{\partial z} &= \sum_{n=1}^{n_{max}} (n + 1)\left(\frac{z}{r}\right)\left(\frac{a}{r}\right)^{(n+2)} \sum_{m=0}^{n} \left\{ P_n^m(\cos{\theta}) \left[ g_n^m \cos{(m\phi)} + h_n^m \sin{(m\phi)}\right] \right\}    \nonumber \\
				&- a \sum_{n=1}^{n_{max}} \left(\frac{a}{r}\right)^{(n+1)} \sum_{m=0}^{n} \biggl\{ \left(\frac{\rho^2}{ r^3}\right)\frac{\text{d}}{\text{d} \theta} P_n^m(\cos{\theta}) \left[g_n^m \cos{(m\phi)} + h_n^m \sin{(m\phi)} \right]  \biggr\}.				
			\end{align}
			
\bibliographystyle{agufull08}
\bibliography{ref}
\end{document}
